# åŠ¨æ€è§„åˆ’ä¹‹KMPå­—ç¬¦åŒ¹é…ç®—æ³•

<p align='center'>
<a href="https://github.com/labuladong/fucking-algorithm" target="view_window"><img alt="GitHub" src="https://img.shields.io/github/stars/labuladong/fucking-algorithm?label=Stars&style=flat-square&logo=GitHub"></a>
<a href="https://appktavsiei5995.pc.xiaoe-tech.com/index" target="_blank"><img class="my_header_icon" src="https://img.shields.io/static/v1?label=ç²¾å“è¯¾ç¨‹&message=æŸ¥çœ‹&color=pink&style=flat"></a>
<a href="https://www.zhihu.com/people/labuladong"><img src="https://img.shields.io/badge/%E7%9F%A5%E4%B9%8E-@labuladong-000000.svg?style=flat-square&logo=Zhihu"></a>
<a href="https://space.bilibili.com/14089380"><img src="https://img.shields.io/badge/Bç«™-@labuladong-000000.svg?style=flat-square&logo=Bilibili"></a>
</p>

![](https://labuladong.github.io/pictures/souyisou1.png)

**é€šçŸ¥ï¼š[æ•°æ®ç»“æ„ç²¾å“è¯¾](https://aep.h5.xeknow.com/s/1XJHEO) å’Œ [é€’å½’ç®—æ³•ä¸“é¢˜è¯¾](https://aep.xet.tech/s/3YGcq3) é™æ—¶é™„èµ ç½‘ç«™ä¼šå‘˜ï¼Œå…¨æ–°çº¸è´¨ä¹¦[ã€Šlabuladong çš„ç®—æ³•ç¬”è®°ã€‹](https://labuladong.gitee.io/algo/images/book/book_intro_qrcode.jpg) å‡ºç‰ˆï¼Œç­¾åç‰ˆé™æ—¶åŠä»·ï¼å¦å¤–ï¼Œå»ºè®®ä½ åœ¨æˆ‘çš„ [ç½‘ç«™](https://labuladong.github.io/algo/) å­¦ä¹ æ–‡ç« ï¼Œä½“éªŒæ›´å¥½ã€‚**



è¯»å®Œæœ¬æ–‡ï¼Œä½ ä¸ä»…å­¦ä¼šäº†ç®—æ³•å¥—è·¯ï¼Œè¿˜å¯ä»¥é¡ºä¾¿è§£å†³å¦‚ä¸‹é¢˜ç›®ï¼š

| LeetCode | åŠ›æ‰£ | éš¾åº¦ |
| :----: | :----: | :----: |
| [28. Find the Index of the First Occurrence in a String](https://leetcode.com/problems/find-the-index-of-the-first-occurrence-in-a-string/) | [28. æ‰¾å‡ºå­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹çš„ä¸‹æ ‡](https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/) | ğŸŸ 

**-----------**

> tipï¼šé˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆå­¦ä¹ ä¸€ä¸‹å¦ä¸€ç§å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼š[Rabin Karp å­—ç¬¦åŒ¹é…ç®—æ³•](https://labuladong.github.io/article/fname.html?fname=rabinkarp)ã€‚

KMP ç®—æ³•ï¼ˆKnuth-Morris-Pratt ç®—æ³•ï¼‰æ˜¯ä¸€ä¸ªè‘—åçš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯ç¡®å®æœ‰ç‚¹å¤æ‚ã€‚

å¾ˆå¤šè¯»è€…æŠ±æ€¨ KMP ç®—æ³•æ— æ³•ç†è§£ï¼Œè¿™å¾ˆæ­£å¸¸ï¼Œæƒ³åˆ°å¤§å­¦æ•™æä¸Šå…³äº KMP ç®—æ³•çš„è®²è§£ï¼Œä¹Ÿä¸çŸ¥é“æœ‰å¤šå°‘æœªæ¥çš„ Knuthã€Morrisã€Pratt è¢«æå‰åŠé€€äº†ã€‚æœ‰ä¸€äº›ä¼˜ç§€çš„åŒå­¦é€šè¿‡æ‰‹æ¨ KMP ç®—æ³•çš„è¿‡ç¨‹æ¥è¾…åŠ©ç†è§£è¯¥ç®—æ³•ï¼Œè¿™æ˜¯ä¸€ç§åŠæ³•ï¼Œä¸è¿‡æœ¬æ–‡è¦ä»é€»è¾‘å±‚é¢å¸®åŠ©è¯»è€…ç†è§£ç®—æ³•çš„åŸç†ã€‚åè¡Œä»£ç ä¹‹é—´ï¼ŒKMP ç°é£çƒŸç­ã€‚

**å…ˆåœ¨å¼€å¤´çº¦å®šï¼Œæœ¬æ–‡ç”¨ `pat` è¡¨ç¤ºæ¨¡å¼ä¸²ï¼Œé•¿åº¦ä¸º `M`ï¼Œ`txt` è¡¨ç¤ºæ–‡æœ¬ä¸²ï¼Œé•¿åº¦ä¸º `N`ã€‚KMP ç®—æ³•æ˜¯åœ¨ `txt` ä¸­æŸ¥æ‰¾å­ä¸² `pat`ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¿”å›è¿™ä¸ªå­ä¸²çš„èµ·å§‹ç´¢å¼•ï¼Œå¦åˆ™è¿”å› -1**ã€‚

ä¸ºä»€ä¹ˆæˆ‘è®¤ä¸º KMP ç®—æ³•å°±æ˜¯ä¸ªåŠ¨æ€è§„åˆ’é—®é¢˜å‘¢ï¼Œç­‰ä¼šå†è§£é‡Šã€‚å¯¹äºåŠ¨æ€è§„åˆ’ï¼Œä¹‹å‰å¤šæ¬¡å¼ºè°ƒäº†è¦æ˜ç¡® `dp` æ•°ç»„çš„å«ä¹‰ï¼Œè€Œä¸”åŒä¸€ä¸ªé—®é¢˜å¯èƒ½æœ‰ä¸æ­¢ä¸€ç§å®šä¹‰ `dp` æ•°ç»„å«ä¹‰çš„æ–¹æ³•ï¼Œä¸åŒçš„å®šä¹‰ä¼šæœ‰ä¸åŒçš„è§£æ³•ã€‚

è¯»è€…è§è¿‡çš„ KMP ç®—æ³•åº”è¯¥æ˜¯ï¼Œä¸€æ³¢è¯¡å¼‚çš„æ“ä½œå¤„ç† `pat` åå½¢æˆä¸€ä¸ªä¸€ç»´çš„æ•°ç»„ `next`ï¼Œç„¶åæ ¹æ®è¿™ä¸ªæ•°ç»„ç»è¿‡åˆä¸€æ³¢å¤æ‚æ“ä½œå»åŒ¹é… `txt`ã€‚æ—¶é—´å¤æ‚åº¦ O(N)ï¼Œç©ºé—´å¤æ‚åº¦ O(M)ã€‚å…¶å®å®ƒè¿™ä¸ª `next` æ•°ç»„å°±ç›¸å½“äº `dp` æ•°ç»„ï¼Œå…¶ä¸­å…ƒç´ çš„å«ä¹‰è·Ÿ `pat` çš„å‰ç¼€å’Œåç¼€æœ‰å…³ï¼Œåˆ¤å®šè§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œä¸å¥½ç†è§£ã€‚**æœ¬æ–‡åˆ™ç”¨ä¸€ä¸ªäºŒç»´çš„ `dp` æ•°ç»„ï¼ˆä½†ç©ºé—´å¤æ‚åº¦è¿˜æ˜¯ O(M)ï¼‰ï¼Œé‡æ–°å®šä¹‰å…¶ä¸­å…ƒç´ çš„å«ä¹‰ï¼Œä½¿å¾—ä»£ç é•¿åº¦å¤§å¤§å‡å°‘ï¼Œå¯è§£é‡Šæ€§å¤§å¤§æé«˜**ã€‚

> noteï¼šæœ¬æ–‡çš„ä»£ç å‚è€ƒã€Šç®—æ³•4ã€‹ï¼ŒåŸä»£ç ä½¿ç”¨çš„æ•°ç»„åç§°æ˜¯ `dfa`ï¼ˆç¡®å®šæœ‰é™çŠ¶æ€æœºï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬çš„å…¬ä¼—å·ä¹‹å‰æœ‰ä¸€ç³»åˆ—åŠ¨æ€è§„åˆ’çš„æ–‡ç« ï¼Œå°±ä¸è¯´è¿™ä¹ˆé«˜å¤§ä¸Šçš„åè¯äº†ï¼Œæˆ‘å¯¹ä¹¦ä¸­ä»£ç è¿›è¡Œäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œå¹¶æ²¿ç”¨ `dp` æ•°ç»„çš„åç§°ã€‚

### ä¸€ã€KMP ç®—æ³•æ¦‚è¿°

é¦–å…ˆè¿˜æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ KMP ç®—æ³•å’Œæš´åŠ›åŒ¹é…ç®—æ³•çš„ä¸åŒåœ¨å“ªé‡Œï¼Œéš¾ç‚¹åœ¨å“ªé‡Œï¼Œå’ŒåŠ¨æ€è§„åˆ’æœ‰å•¥å…³ç³»ã€‚

åŠ›æ‰£ç¬¬ 28 é¢˜ã€Œå®ç° strStrã€å°±æ˜¯å­—ç¬¦ä¸²åŒ¹é…é—®é¢˜ï¼Œæš´åŠ›çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•å¾ˆå®¹æ˜“å†™ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„è¿è¡Œé€»è¾‘ï¼š

<!-- muliti_language -->
```java
// æš´åŠ›åŒ¹é…ï¼ˆä¼ªç ï¼‰
int search(String pat, String txt) {
    int M = pat.length;
    int N = txt.length;
    for (int i = 0; i <= N - M; i++) {
        int j;
        for (j = 0; j < M; j++) {
            if (pat[j] != txt[i+j])
                break;
        }
        // pat å…¨éƒ½åŒ¹é…äº†
        if (j == M) return i;
    }
    // txt ä¸­ä¸å­˜åœ¨ pat å­ä¸²
    return -1;
}
```

å¯¹äºæš´åŠ›ç®—æ³•ï¼Œå¦‚æœå‡ºç°ä¸åŒ¹é…å­—ç¬¦ï¼ŒåŒæ—¶å›é€€ `txt` å’Œ `pat` çš„æŒ‡é’ˆï¼ŒåµŒå¥— for å¾ªç¯ï¼Œæ—¶é—´å¤æ‚åº¦ `O(MN)`ï¼Œç©ºé—´å¤æ‚åº¦`O(1)`ã€‚æœ€ä¸»è¦çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­é‡å¤çš„å­—ç¬¦æ¯”è¾ƒå¤šï¼Œè¯¥ç®—æ³•å°±æ˜¾å¾—å¾ˆè ¢ã€‚

æ¯”å¦‚ `txt = "aaacaaab", pat = "aaab"`ï¼š

![](https://labuladong.github.io/pictures/kmp/1.gif)

å¾ˆæ˜æ˜¾ï¼Œ`pat` ä¸­æ ¹æœ¬æ²¡æœ‰å­—ç¬¦ cï¼Œæ ¹æœ¬æ²¡å¿…è¦å›é€€æŒ‡é’ˆ `i`ï¼Œæš´åŠ›è§£æ³•æ˜æ˜¾å¤šåšäº†å¾ˆå¤šä¸å¿…è¦çš„æ“ä½œã€‚

KMP ç®—æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¼šèŠ±è´¹ç©ºé—´æ¥è®°å½•ä¸€äº›ä¿¡æ¯ï¼Œåœ¨ä¸Šè¿°æƒ…å†µä¸­å°±ä¼šæ˜¾å¾—å¾ˆèªæ˜ï¼š

![](https://labuladong.github.io/pictures/kmp/2.gif)

å†æ¯”å¦‚ç±»ä¼¼çš„ `txt = "aaaaaaab", pat = "aaab"`ï¼Œæš´åŠ›è§£æ³•è¿˜ä¼šå’Œä¸Šé¢é‚£ä¸ªä¾‹å­ä¸€æ ·è ¢è ¢åœ°å›é€€æŒ‡é’ˆ `i`ï¼Œè€Œ KMP ç®—æ³•åˆä¼šè€èªæ˜ï¼š

![](https://labuladong.github.io/pictures/kmp/3.gif)

å› ä¸º KMP ç®—æ³•çŸ¥é“å­—ç¬¦ b ä¹‹å‰çš„å­—ç¬¦ a éƒ½æ˜¯åŒ¹é…çš„ï¼Œæ‰€ä»¥æ¯æ¬¡åªéœ€è¦æ¯”è¾ƒå­—ç¬¦ b æ˜¯å¦è¢«åŒ¹é…å°±è¡Œäº†ã€‚

**KMP ç®—æ³•æ°¸ä¸å›é€€ `txt` çš„æŒ‡é’ˆ `i`ï¼Œä¸èµ°å›å¤´è·¯ï¼ˆä¸ä¼šé‡å¤æ‰«æ `txt`ï¼‰ï¼Œè€Œæ˜¯å€ŸåŠ© `dp` æ•°ç»„ä¸­å‚¨å­˜çš„ä¿¡æ¯æŠŠ `pat` ç§»åˆ°æ­£ç¡®çš„ä½ç½®ç»§ç»­åŒ¹é…**ï¼Œæ—¶é—´å¤æ‚åº¦åªéœ€ O(N)ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºå®ƒæ˜¯ä¸€ç§åŠ¨æ€è§„åˆ’ç®—æ³•ã€‚

KMP ç®—æ³•çš„éš¾ç‚¹åœ¨äºï¼Œå¦‚ä½•è®¡ç®— `dp` æ•°ç»„ä¸­çš„ä¿¡æ¯ï¼Ÿå¦‚ä½•æ ¹æ®è¿™äº›ä¿¡æ¯æ­£ç¡®åœ°ç§»åŠ¨ `pat` çš„æŒ‡é’ˆï¼Ÿè¿™ä¸ªå°±éœ€è¦**ç¡®å®šæœ‰é™çŠ¶æ€è‡ªåŠ¨æœº**æ¥è¾…åŠ©äº†ï¼Œåˆ«æ€•è¿™ç§é«˜å¤§ä¸Šçš„æ–‡å­¦è¯æ±‡ï¼Œå…¶å®å’ŒåŠ¨æ€è§„åˆ’çš„ `dp` æ•°ç»„å¦‚å‡ºä¸€è¾™ï¼Œç­‰ä½ å­¦ä¼šäº†ä¹Ÿå¯ä»¥æ‹¿è¿™ä¸ªè¯å»å“å”¬åˆ«äººã€‚

è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ˜ç¡®çš„æ˜¯ï¼š**è®¡ç®—è¿™ä¸ª `dp` æ•°ç»„ï¼Œåªå’Œ `pat` ä¸²æœ‰å…³**ã€‚æ„æ€æ˜¯è¯´ï¼Œåªè¦ç»™æˆ‘ä¸ª `pat`ï¼Œæˆ‘å°±èƒ½é€šè¿‡è¿™ä¸ªæ¨¡å¼ä¸²è®¡ç®—å‡º `dp` æ•°ç»„ï¼Œç„¶åä½ å¯ä»¥ç»™æˆ‘ä¸åŒçš„ `txt`ï¼Œæˆ‘éƒ½ä¸æ€•ï¼Œåˆ©ç”¨è¿™ä¸ª `dp` æ•°ç»„æˆ‘éƒ½èƒ½åœ¨ O(N) æ—¶é—´å®Œæˆå­—ç¬¦ä¸²åŒ¹é…ã€‚

å…·ä½“æ¥è¯´ï¼Œæ¯”å¦‚ä¸Šæ–‡ä¸¾çš„ä¸¤ä¸ªä¾‹å­ï¼š

```python
txt1 = "aaacaaab" 
pat = "aaab"
txt2 = "aaaaaaab" 
pat = "aaab"
```

æˆ‘ä»¬çš„ `txt` ä¸åŒï¼Œä½†æ˜¯ `pat` æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ KMP ç®—æ³•ä½¿ç”¨çš„ `dp` æ•°ç»„æ˜¯åŒä¸€ä¸ªã€‚

åªä¸è¿‡å¯¹äº `txt1` çš„ä¸‹é¢è¿™ä¸ªå³å°†å‡ºç°çš„æœªåŒ¹é…æƒ…å†µï¼š

![](https://labuladong.github.io/pictures/kmp/txt1.jpg)

`dp` æ•°ç»„æŒ‡ç¤º `pat` è¿™æ ·ç§»åŠ¨ï¼š

![](https://labuladong.github.io/pictures/kmp/txt2.jpg)

> noteï¼šè¿™ä¸ª`j` ä¸è¦ç†è§£ä¸ºç´¢å¼•ï¼Œå®ƒçš„å«ä¹‰æ›´å‡†ç¡®åœ°è¯´åº”è¯¥æ˜¯**çŠ¶æ€**ï¼ˆstateï¼‰ï¼Œæ‰€ä»¥å®ƒä¼šå‡ºç°è¿™ä¸ªå¥‡æ€ªçš„ä½ç½®ï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚

è€Œå¯¹äº `txt2` çš„ä¸‹é¢è¿™ä¸ªå³å°†å‡ºç°çš„æœªåŒ¹é…æƒ…å†µï¼š

![](https://labuladong.github.io/pictures/kmp/txt3.jpg)

`dp` æ•°ç»„æŒ‡ç¤º `pat` è¿™æ ·ç§»åŠ¨ï¼š

![](https://labuladong.github.io/pictures/kmp/txt4.jpg)

æ˜ç™½äº† `dp` æ•°ç»„åªå’Œ `pat` æœ‰å…³ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™æ ·è®¾è®¡ KMP ç®—æ³•å°±ä¼šæ¯”è¾ƒæ¼‚äº®ï¼š

<!-- muliti_language -->
```java
public class KMP {
    private int[][] dp;
    private String pat;

    public KMP(String pat) {
        this.pat = pat;
        // é€šè¿‡ pat æ„å»º dp æ•°ç»„
        // éœ€è¦ O(M) æ—¶é—´
    }

    public int search(String txt) {
        // å€ŸåŠ© dp æ•°ç»„å»åŒ¹é… txt
        // éœ€è¦ O(N) æ—¶é—´
    }
}
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬éœ€è¦ç”¨åŒä¸€ `pat` å»åŒ¹é…ä¸åŒ `txt` æ—¶ï¼Œå°±ä¸éœ€è¦æµªè´¹æ—¶é—´æ„é€  `dp` æ•°ç»„äº†ï¼š

```java
KMP kmp = new KMP("aaab");
int pos1 = kmp.search("aaacaaab"); //4
int pos2 = kmp.search("aaaaaaab"); //4
```

### äºŒã€çŠ¶æ€æœºæ¦‚è¿°

ä¸ºä»€ä¹ˆè¯´ KMP ç®—æ³•å’ŒçŠ¶æ€æœºæœ‰å…³å‘¢ï¼Ÿæ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º `pat` çš„åŒ¹é…å°±æ˜¯çŠ¶æ€çš„è½¬ç§»ã€‚æ¯”å¦‚å½“ pat = "ABABC"ï¼š

![](https://labuladong.github.io/pictures/kmp/state.jpg)

å¦‚ä¸Šå›¾ï¼Œåœ†åœˆå†…çš„æ•°å­—å°±æ˜¯çŠ¶æ€ï¼ŒçŠ¶æ€ 0 æ˜¯èµ·å§‹çŠ¶æ€ï¼ŒçŠ¶æ€ 5ï¼ˆ`pat.length`ï¼‰æ˜¯ç»ˆæ­¢çŠ¶æ€ã€‚å¼€å§‹åŒ¹é…æ—¶ `pat` å¤„äºèµ·å§‹çŠ¶æ€ï¼Œä¸€æ—¦è½¬ç§»åˆ°ç»ˆæ­¢çŠ¶æ€ï¼Œå°±è¯´æ˜åœ¨ `txt` ä¸­æ‰¾åˆ°äº† `pat`ã€‚æ¯”å¦‚è¯´å½“å‰å¤„äºçŠ¶æ€ 2ï¼Œå°±è¯´æ˜å­—ç¬¦ "AB" è¢«åŒ¹é…ï¼š

![](https://labuladong.github.io/pictures/kmp/state2.jpg)

å¦å¤–ï¼Œå¤„äºä¸åŒçŠ¶æ€æ—¶ï¼Œ`pat` çŠ¶æ€è½¬ç§»çš„è¡Œä¸ºä¹Ÿä¸åŒã€‚æ¯”å¦‚è¯´å‡è®¾ç°åœ¨åŒ¹é…åˆ°äº†çŠ¶æ€ 4ï¼Œå¦‚æœé‡åˆ°å­—ç¬¦ A å°±åº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ 3ï¼Œé‡åˆ°å­—ç¬¦ C å°±åº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ 5ï¼Œå¦‚æœé‡åˆ°å­—ç¬¦ B å°±åº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ 0ï¼š

![](https://labuladong.github.io/pictures/kmp/state4.jpg)

å…·ä½“ä»€ä¹ˆæ„æ€å‘¢ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªä¸ªä¸¾ä¾‹çœ‹çœ‹ã€‚ç”¨å˜é‡ `j` è¡¨ç¤ºæŒ‡å‘å½“å‰çŠ¶æ€çš„æŒ‡é’ˆï¼Œå½“å‰ `pat` åŒ¹é…åˆ°äº†çŠ¶æ€ 4ï¼š

![](https://labuladong.github.io/pictures/kmp/exp1.jpg)

å¦‚æœé‡åˆ°äº†å­—ç¬¦ "A"ï¼Œæ ¹æ®ç®­å¤´æŒ‡ç¤ºï¼Œè½¬ç§»åˆ°çŠ¶æ€ 3 æ˜¯æœ€èªæ˜çš„ï¼š

![](https://labuladong.github.io/pictures/kmp/exp3.jpg)

å¦‚æœé‡åˆ°äº†å­—ç¬¦ "B"ï¼Œæ ¹æ®ç®­å¤´æŒ‡ç¤ºï¼Œåªèƒ½è½¬ç§»åˆ°çŠ¶æ€ 0ï¼ˆä¸€å¤œå›åˆ°è§£æ”¾å‰ï¼‰ï¼š

![](https://labuladong.github.io/pictures/kmp/exp5.jpg)

å¦‚æœé‡åˆ°äº†å­—ç¬¦ "C"ï¼Œæ ¹æ®ç®­å¤´æŒ‡ç¤ºï¼Œåº”è¯¥è½¬ç§»åˆ°ç»ˆæ­¢çŠ¶æ€ 5ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åŒ¹é…å®Œæˆï¼š

![](https://labuladong.github.io/pictures/kmp/exp7.jpg)

å½“ç„¶äº†ï¼Œè¿˜å¯èƒ½é‡åˆ°å…¶ä»–å­—ç¬¦ï¼Œæ¯”å¦‚ Zï¼Œä½†æ˜¯æ˜¾ç„¶åº”è¯¥è½¬ç§»åˆ°èµ·å§‹çŠ¶æ€ 0ï¼Œå› ä¸º `pat` ä¸­æ ¹æœ¬éƒ½æ²¡æœ‰å­—ç¬¦ Zï¼š

![](https://labuladong.github.io/pictures/kmp/z.jpg)

è¿™é‡Œä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬ç”»çŠ¶æ€å›¾æ—¶å°±æŠŠå…¶ä»–å­—ç¬¦è½¬ç§»åˆ°çŠ¶æ€ 0 çš„ç®­å¤´çœç•¥ï¼Œåªç”» `pat` ä¸­å‡ºç°çš„å­—ç¬¦çš„çŠ¶æ€è½¬ç§»ï¼š

![](https://labuladong.github.io/pictures/kmp/allstate.jpg)

KMP ç®—æ³•æœ€å…³é”®çš„æ­¥éª¤å°±æ˜¯æ„é€ è¿™ä¸ªçŠ¶æ€è½¬ç§»å›¾ã€‚**è¦ç¡®å®šçŠ¶æ€è½¬ç§»çš„è¡Œä¸ºï¼Œå¾—æ˜ç¡®ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯å½“å‰çš„åŒ¹é…çŠ¶æ€ï¼Œå¦ä¸€ä¸ªæ˜¯é‡åˆ°çš„å­—ç¬¦**ï¼›ç¡®å®šäº†è¿™ä¸¤ä¸ªå˜é‡åï¼Œå°±å¯ä»¥çŸ¥é“è¿™ä¸ªæƒ…å†µä¸‹åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ã€‚

ä¸‹é¢çœ‹ä¸€ä¸‹ KMP ç®—æ³•æ ¹æ®è¿™å¹…çŠ¶æ€è½¬ç§»å›¾åŒ¹é…å­—ç¬¦ä¸² `txt` çš„è¿‡ç¨‹ï¼š

![](https://labuladong.github.io/pictures/kmp/kmp.gif)

**è¯·è®°ä½è¿™ä¸ª GIF çš„åŒ¹é…è¿‡ç¨‹ï¼Œè¿™å°±æ˜¯ KMP ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘**ï¼

ä¸ºäº†æè¿°çŠ¶æ€è½¬ç§»å›¾ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªäºŒç»´ dp æ•°ç»„ï¼Œå®ƒçš„å«ä¹‰å¦‚ä¸‹ï¼š

```python
dp[j][c] = next
0 <= j < Mï¼Œä»£è¡¨å½“å‰çš„çŠ¶æ€
0 <= c < 256ï¼Œä»£è¡¨é‡åˆ°çš„å­—ç¬¦ï¼ˆASCII ç ï¼‰
0 <= next <= Mï¼Œä»£è¡¨ä¸‹ä¸€ä¸ªçŠ¶æ€

dp[4]['A'] = 3 è¡¨ç¤ºï¼š
å½“å‰æ˜¯çŠ¶æ€ 4ï¼Œå¦‚æœé‡åˆ°å­—ç¬¦ Aï¼Œ
pat åº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ 3

dp[1]['B'] = 2 è¡¨ç¤ºï¼š
å½“å‰æ˜¯çŠ¶æ€ 1ï¼Œå¦‚æœé‡åˆ°å­—ç¬¦ Bï¼Œ
pat åº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ 2
```

æ ¹æ®æˆ‘ä»¬è¿™ä¸ª dp æ•°ç»„çš„å®šä¹‰å’Œåˆšæ‰çŠ¶æ€è½¬ç§»çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å‡º KMP ç®—æ³•çš„ search å‡½æ•°ä»£ç ï¼š

<!-- muliti_language -->
```java
public int search(String txt) {
    int M = pat.length();
    int N = txt.length();
    // pat çš„åˆå§‹æ€ä¸º 0
    int j = 0;
    for (int i = 0; i < N; i++) {
        // å½“å‰æ˜¯çŠ¶æ€ jï¼Œé‡åˆ°å­—ç¬¦ txt[i]ï¼Œ
        // pat åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿ
        j = dp[j][txt.charAt(i)];
        // å¦‚æœè¾¾åˆ°ç»ˆæ­¢æ€ï¼Œè¿”å›åŒ¹é…å¼€å¤´çš„ç´¢å¼•
        if (j == M) return i - M + 1;
    }
    // æ²¡åˆ°è¾¾ç»ˆæ­¢æ€ï¼ŒåŒ¹é…å¤±è´¥
    return -1;
}
```

åˆ°è¿™é‡Œï¼Œåº”è¯¥è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„å§ï¼Œ`dp` æ•°ç»„å°±æ˜¯æˆ‘ä»¬åˆšæ‰ç”»çš„é‚£å¹…çŠ¶æ€è½¬ç§»å›¾ï¼Œå¦‚æœä¸æ¸…æ¥šçš„è¯å›å»çœ‹ä¸‹ GIF çš„ç®—æ³•æ¼”è¿›è¿‡ç¨‹ã€‚ä¸‹é¢è®²è§£ï¼šå¦‚ä½•é€šè¿‡ `pat` æ„å»ºè¿™ä¸ª `dp` æ•°ç»„ï¼Ÿ

### ä¸‰ã€æ„å»ºçŠ¶æ€è½¬ç§»å›¾

å›æƒ³åˆšæ‰è¯´çš„ï¼š**è¦ç¡®å®šçŠ¶æ€è½¬ç§»çš„è¡Œä¸ºï¼Œå¿…é¡»æ˜ç¡®ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯å½“å‰çš„åŒ¹é…çŠ¶æ€ï¼Œå¦ä¸€ä¸ªæ˜¯é‡åˆ°çš„å­—ç¬¦**ï¼Œè€Œä¸”æˆ‘ä»¬å·²ç»æ ¹æ®è¿™ä¸ªé€»è¾‘ç¡®å®šäº† `dp` æ•°ç»„çš„å«ä¹‰ï¼Œé‚£ä¹ˆæ„é€  `dp` æ•°ç»„çš„æ¡†æ¶å°±æ˜¯è¿™æ ·ï¼š

```python
for 0 <= j < M: # çŠ¶æ€
    for 0 <= c < 256: # å­—ç¬¦
        dp[j][c] = next
```

è¿™ä¸ª next çŠ¶æ€åº”è¯¥æ€ä¹ˆæ±‚å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œ**å¦‚æœé‡åˆ°çš„å­—ç¬¦ `c` å’Œ `pat[j]` åŒ¹é…çš„è¯**ï¼ŒçŠ¶æ€å°±åº”è¯¥å‘å‰æ¨è¿›ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ `next = j + 1`ï¼Œæˆ‘ä»¬ä¸å¦¨ç§°è¿™ç§æƒ…å†µä¸º**çŠ¶æ€æ¨è¿›**ï¼š

![](https://labuladong.github.io/pictures/kmp/forward.jpg)

**å¦‚æœå­—ç¬¦ `c` å’Œ `pat[j]` ä¸åŒ¹é…çš„è¯**ï¼ŒçŠ¶æ€å°±è¦å›é€€ï¼ˆæˆ–è€…åŸåœ°ä¸åŠ¨ï¼‰ï¼Œæˆ‘ä»¬ä¸å¦¨ç§°è¿™ç§æƒ…å†µä¸º**çŠ¶æ€é‡å¯**ï¼š

![](https://labuladong.github.io/pictures/kmp/back.jpg)

é‚£ä¹ˆï¼Œå¦‚ä½•å¾—çŸ¥åœ¨å“ªä¸ªçŠ¶æ€é‡å¯å‘¢ï¼Ÿè§£ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªåå­—ï¼š**å½±å­çŠ¶æ€**ï¼ˆæˆ‘ç¼–çš„åå­—ï¼‰ï¼Œç”¨å˜é‡ `X` è¡¨ç¤ºã€‚**æ‰€è°“å½±å­çŠ¶æ€ï¼Œå°±æ˜¯å’Œå½“å‰çŠ¶æ€å…·æœ‰ç›¸åŒçš„å‰ç¼€**ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼š

![](https://labuladong.github.io/pictures/kmp/shadow.jpg)

å½“å‰çŠ¶æ€ `j = 4`ï¼Œå…¶å½±å­çŠ¶æ€ä¸º `X = 2`ï¼Œå®ƒä»¬éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ "AB"ã€‚å› ä¸ºçŠ¶æ€ `X` å’ŒçŠ¶æ€ `j` å­˜åœ¨ç›¸åŒçš„å‰ç¼€ï¼Œæ‰€ä»¥å½“çŠ¶æ€ `j` å‡†å¤‡è¿›è¡ŒçŠ¶æ€é‡å¯çš„æ—¶å€™ï¼ˆé‡åˆ°çš„å­—ç¬¦ `c` å’Œ `pat[j]` ä¸åŒ¹é…ï¼‰ï¼Œå¯ä»¥é€šè¿‡ `X` çš„çŠ¶æ€è½¬ç§»å›¾æ¥è·å¾—**æœ€è¿‘çš„é‡å¯ä½ç½®**ã€‚

æ¯”å¦‚è¯´åˆšæ‰çš„æƒ…å†µï¼Œå¦‚æœçŠ¶æ€ `j` é‡åˆ°ä¸€ä¸ªå­—ç¬¦ "A"ï¼Œåº”è¯¥è½¬ç§»åˆ°å“ªé‡Œå‘¢ï¼Ÿé¦–å…ˆåªæœ‰é‡åˆ° "C" æ‰èƒ½æ¨è¿›çŠ¶æ€ï¼Œé‡åˆ° "A" æ˜¾ç„¶åªèƒ½è¿›è¡ŒçŠ¶æ€é‡å¯ã€‚**çŠ¶æ€ `j` ä¼šæŠŠè¿™ä¸ªå­—ç¬¦å§”æ‰˜ç»™çŠ¶æ€ `X` å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ `dp[j]['A'] = dp[X]['A']`**ï¼š

![](https://labuladong.github.io/pictures/kmp/shadow1.jpg)

ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥å‘¢ï¼Ÿå› ä¸ºï¼šæ—¢ç„¶ `j` è¿™è¾¹å·²ç»ç¡®å®šå­—ç¬¦ "A" æ— æ³•æ¨è¿›çŠ¶æ€ï¼Œ**åªèƒ½å›é€€**ï¼Œè€Œä¸” KMP å°±æ˜¯è¦**å°½å¯èƒ½å°‘çš„å›é€€**ï¼Œä»¥å…å¤šä½™çš„è®¡ç®—ã€‚é‚£ä¹ˆ `j` å°±å¯ä»¥å»é—®é—®å’Œè‡ªå·±å…·æœ‰ç›¸åŒå‰ç¼€çš„ `X`ï¼Œå¦‚æœ `X` é‡è§ "A" å¯ä»¥è¿›è¡Œã€ŒçŠ¶æ€æ¨è¿›ã€ï¼Œé‚£å°±è½¬ç§»è¿‡å»ï¼Œå› ä¸ºè¿™æ ·å›é€€æœ€å°‘ã€‚

![](https://labuladong.github.io/pictures/kmp/A.gif)

å½“ç„¶ï¼Œå¦‚æœé‡åˆ°çš„å­—ç¬¦æ˜¯ "B"ï¼ŒçŠ¶æ€ `X` ä¹Ÿä¸èƒ½è¿›è¡Œã€ŒçŠ¶æ€æ¨è¿›ã€ï¼Œåªèƒ½å›é€€ï¼Œ`j` åªè¦è·Ÿç€ `X` æŒ‡å¼•çš„æ–¹å‘å›é€€å°±è¡Œäº†ï¼š

![](https://labuladong.github.io/pictures/kmp/shadow2.jpg)

ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œè¿™ä¸ª `X` æ€ä¹ˆçŸ¥é“é‡åˆ°å­—ç¬¦ "B" è¦å›é€€åˆ°çŠ¶æ€ 0 å‘¢ï¼Ÿå› ä¸º `X` æ°¸è¿œè·Ÿåœ¨ `j` çš„èº«åï¼ŒçŠ¶æ€ `X` å¦‚ä½•è½¬ç§»ï¼Œåœ¨ä¹‹å‰å°±å·²ç»ç®—å‡ºæ¥äº†ã€‚åŠ¨æ€è§„åˆ’ç®—æ³•ä¸å°±æ˜¯åˆ©ç”¨è¿‡å»çš„ç»“æœè§£å†³ç°åœ¨çš„é—®é¢˜å—ï¼Ÿ

è¿™æ ·ï¼Œæˆ‘ä»¬å°±ç»†åŒ–ä¸€ä¸‹åˆšæ‰çš„æ¡†æ¶ä»£ç ï¼š

```python
int X # å½±å­çŠ¶æ€
for 0 <= j < M:
    for 0 <= c < 256:
        if c == pat[j]:
            # çŠ¶æ€æ¨è¿›
            dp[j][c] = j + 1
        else: 
            # çŠ¶æ€é‡å¯
            # å§”æ‰˜ X è®¡ç®—é‡å¯ä½ç½®
            dp[j][c] = dp[X][c] 
```

### å››ã€ä»£ç å®ç°

å¦‚æœä¹‹å‰çš„å†…å®¹ä½ éƒ½èƒ½ç†è§£ï¼Œæ­å–œä½ ï¼Œç°åœ¨å°±å‰©ä¸‹ä¸€ä¸ªé—®é¢˜ï¼šå½±å­çŠ¶æ€ `X` æ˜¯å¦‚ä½•å¾—åˆ°çš„å‘¢ï¼Ÿä¸‹é¢å…ˆç›´æ¥çœ‹å®Œæ•´ä»£ç å§ã€‚

<!-- muliti_language -->
```java
public class KMP {
    private int[][] dp;
    private String pat;

    public KMP(String pat) {
        this.pat = pat;
        int M = pat.length();
        // dp[çŠ¶æ€][å­—ç¬¦] = ä¸‹ä¸ªçŠ¶æ€
        dp = new int[M][256];
        // base case
        dp[0][pat.charAt(0)] = 1;
        // å½±å­çŠ¶æ€ X åˆå§‹ä¸º 0
        int X = 0;
        // å½“å‰çŠ¶æ€ j ä» 1 å¼€å§‹
        for (int j = 1; j < M; j++) {
            for (int c = 0; c < 256; c++) {
                if (pat.charAt(j) == c) 
                    dp[j][c] = j + 1;
                else 
                    dp[j][c] = dp[X][c];
            }
            // æ›´æ–°å½±å­çŠ¶æ€
            X = dp[X][pat.charAt(j)];
        }
    }

    public int search(String txt) {...}
}
```

å…ˆè§£é‡Šä¸€ä¸‹è¿™ä¸€è¡Œä»£ç ï¼š

```java
// base case
dp[0][pat.charAt(0)] = 1;
```

è¿™è¡Œä»£ç æ˜¯ base caseï¼Œåªæœ‰é‡åˆ° pat[0] è¿™ä¸ªå­—ç¬¦æ‰èƒ½ä½¿çŠ¶æ€ä» 0 è½¬ç§»åˆ° 1ï¼Œé‡åˆ°å…¶å®ƒå­—ç¬¦çš„è¯è¿˜æ˜¯åœç•™åœ¨çŠ¶æ€ 0ï¼ˆJava é»˜è®¤åˆå§‹åŒ–æ•°ç»„å…¨ä¸º 0ï¼‰ã€‚

å½±å­çŠ¶æ€ `X` æ˜¯å…ˆåˆå§‹åŒ–ä¸º 0ï¼Œç„¶åéšç€ `j` çš„å‰è¿›è€Œä¸æ–­æ›´æ–°çš„ã€‚ä¸‹é¢çœ‹çœ‹åˆ°åº•åº”è¯¥**å¦‚ä½•æ›´æ–°å½±å­çŠ¶æ€ `X`**ï¼š

```java
int X = 0;
for (int j = 1; j < M; j++) {
    ...
    // æ›´æ–°å½±å­çŠ¶æ€
    // å½“å‰æ˜¯çŠ¶æ€ Xï¼Œé‡åˆ°å­—ç¬¦ pat[j]ï¼Œ
    // pat åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿ
    X = dp[X][pat.charAt(j)];
}
```

æ›´æ–° `X` å…¶å®å’Œ `search` å‡½æ•°ä¸­æ›´æ–°çŠ¶æ€ `j` çš„è¿‡ç¨‹æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼š

```java
int j = 0;
for (int i = 0; i < N; i++) {
    // å½“å‰æ˜¯çŠ¶æ€ jï¼Œé‡åˆ°å­—ç¬¦ txt[i]ï¼Œ
    // pat åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿ
    j = dp[j][txt.charAt(i)];
    ...
}
```

**å…¶ä¸­çš„åŸç†éå¸¸å¾®å¦™**ï¼Œæ³¨æ„ä»£ç ä¸­ for å¾ªç¯çš„å˜é‡åˆå§‹å€¼ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼šåè€…æ˜¯åœ¨ `txt` ä¸­åŒ¹é… `pat`ï¼Œå‰è€…æ˜¯åœ¨ `pat` ä¸­åŒ¹é… `pat[1..end]`ï¼ŒçŠ¶æ€ `X` æ€»æ˜¯è½åçŠ¶æ€ `j` ä¸€ä¸ªçŠ¶æ€ï¼Œä¸ `j` å…·æœ‰æœ€é•¿çš„ç›¸åŒå‰ç¼€ã€‚æ‰€ä»¥æˆ‘æŠŠ `X` æ¯”å–»ä¸ºå½±å­çŠ¶æ€ï¼Œä¼¼ä¹ä¹Ÿæœ‰ä¸€ç‚¹è´´åˆ‡ã€‚

å¦å¤–ï¼Œæ„å»º dp æ•°ç»„æ˜¯æ ¹æ® base case `dp[0][..]` å‘åæ¨æ¼”ã€‚è¿™å°±æ˜¯æˆ‘è®¤ä¸º KMP ç®—æ³•å°±æ˜¯ä¸€ç§åŠ¨æ€è§„åˆ’ç®—æ³•çš„åŸå› ã€‚

ä¸‹é¢æ¥çœ‹ä¸€ä¸‹çŠ¶æ€è½¬ç§»å›¾çš„å®Œæ•´æ„é€ è¿‡ç¨‹ï¼Œä½ å°±èƒ½ç†è§£çŠ¶æ€ `X` ä½œç”¨ä¹‹ç²¾å¦™äº†ï¼š

![](https://labuladong.github.io/pictures/kmp/dfa.gif)

è‡³æ­¤ï¼ŒKMP ç®—æ³•çš„æ ¸å¿ƒç»ˆäºå†™å®Œå•¦å•¦å•¦å•¦ï¼çœ‹ä¸‹ KMP ç®—æ³•çš„å®Œæ•´ä»£ç å§ï¼š

<!-- muliti_language -->
```java
public class KMP {
    private int[][] dp;
    private String pat;

    public KMP(String pat) {
        this.pat = pat;
        int M = pat.length();
        // dp[çŠ¶æ€][å­—ç¬¦] = ä¸‹ä¸ªçŠ¶æ€
        dp = new int[M][256];
        // base case
        dp[0][pat.charAt(0)] = 1;
        // å½±å­çŠ¶æ€ X åˆå§‹ä¸º 0
        int X = 0;
        // æ„å»ºçŠ¶æ€è½¬ç§»å›¾ï¼ˆç¨æ”¹çš„æ›´ç´§å‡‘äº†ï¼‰
        for (int j = 1; j < M; j++) {
            for (int c = 0; c < 256; c++)
                dp[j][c] = dp[X][c];
            dp[j][pat.charAt(j)] = j + 1;
            // æ›´æ–°å½±å­çŠ¶æ€
            X = dp[X][pat.charAt(j)];
        }
    }

    public int search(String txt) {
        int M = pat.length();
        int N = txt.length();
        // pat çš„åˆå§‹æ€ä¸º 0
        int j = 0;
        for (int i = 0; i < N; i++) {
            // è®¡ç®— pat çš„ä¸‹ä¸€ä¸ªçŠ¶æ€
            j = dp[j][txt.charAt(i)];
            // åˆ°è¾¾ç»ˆæ­¢æ€ï¼Œè¿”å›ç»“æœ
            if (j == M) return i - M + 1;
        }
        // æ²¡åˆ°è¾¾ç»ˆæ­¢æ€ï¼ŒåŒ¹é…å¤±è´¥
        return -1;
    }
}
```

ç»è¿‡ä¹‹å‰çš„è¯¦ç»†ä¸¾ä¾‹è®²è§£ï¼Œä½ åº”è¯¥å¯ä»¥ç†è§£è¿™æ®µä»£ç çš„å«ä¹‰äº†ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŠŠ KMP ç®—æ³•å†™æˆä¸€ä¸ªå‡½æ•°ã€‚æ ¸å¿ƒä»£ç ä¹Ÿå°±æ˜¯ä¸¤ä¸ªå‡½æ•°ä¸­ for å¾ªç¯çš„éƒ¨åˆ†ï¼Œæ•°ä¸€ä¸‹æœ‰è¶…è¿‡åè¡Œå—ï¼Ÿ

### äº”ã€æœ€åæ€»ç»“

ä¼ ç»Ÿçš„ KMP ç®—æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸€ç»´æ•°ç»„ `next` è®°å½•å‰ç¼€ä¿¡æ¯ï¼Œè€Œæœ¬æ–‡æ˜¯ä½¿ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„ `dp` ä»¥çŠ¶æ€è½¬ç§»çš„è§’åº¦è§£å†³å­—ç¬¦åŒ¹é…é—®é¢˜ï¼Œä½†æ˜¯ç©ºé—´å¤æ‚åº¦ä»ç„¶æ˜¯ O(256M) = O(M)ã€‚

åœ¨ `pat` åŒ¹é… `txt` çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦æ˜ç¡®äº†ã€Œå½“å‰å¤„åœ¨å“ªä¸ªçŠ¶æ€ã€å’Œã€Œé‡åˆ°çš„å­—ç¬¦æ˜¯ä»€ä¹ˆã€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå°±å¯ä»¥ç¡®å®šåº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€ï¼ˆæ¨è¿›æˆ–å›é€€ï¼‰ã€‚

å¯¹äºä¸€ä¸ªæ¨¡å¼ä¸² `pat`ï¼Œå…¶æ€»å…±å°±æœ‰ M ä¸ªçŠ¶æ€ï¼Œå¯¹äº ASCII å­—ç¬¦ï¼Œæ€»å…±ä¸ä¼šè¶…è¿‡ 256 ç§ã€‚æ‰€ä»¥æˆ‘ä»¬å°±æ„é€ ä¸€ä¸ªæ•°ç»„ `dp[M][256]` æ¥åŒ…å«æ‰€æœ‰æƒ…å†µï¼Œå¹¶ä¸”æ˜ç¡® `dp` æ•°ç»„çš„å«ä¹‰ï¼š

`dp[j][c] = next` è¡¨ç¤ºï¼Œå½“å‰æ˜¯çŠ¶æ€ `j`ï¼Œé‡åˆ°äº†å­—ç¬¦ `c`ï¼Œåº”è¯¥è½¬ç§»åˆ°çŠ¶æ€ `next`ã€‚

æ˜ç¡®äº†å…¶å«ä¹‰ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“å†™å‡º search å‡½æ•°çš„ä»£ç ã€‚

å¯¹äºå¦‚ä½•æ„å»ºè¿™ä¸ª `dp` æ•°ç»„ï¼Œéœ€è¦ä¸€ä¸ªè¾…åŠ©çŠ¶æ€ `X`ï¼Œå®ƒæ°¸è¿œæ¯”å½“å‰çŠ¶æ€ `j` è½åä¸€ä¸ªçŠ¶æ€ï¼Œæ‹¥æœ‰å’Œ `j` æœ€é•¿çš„ç›¸åŒå‰ç¼€ï¼Œæˆ‘ä»¬ç»™å®ƒèµ·äº†ä¸ªåå­—å«ã€Œå½±å­çŠ¶æ€ã€ã€‚

åœ¨æ„å»ºå½“å‰çŠ¶æ€ `j` çš„è½¬ç§»æ–¹å‘æ—¶ï¼Œåªæœ‰å­—ç¬¦ `pat[j]` æ‰èƒ½ä½¿çŠ¶æ€æ¨è¿›ï¼ˆ`dp[j][pat[j]] = j+1`ï¼‰ï¼›è€Œå¯¹äºå…¶ä»–å­—ç¬¦åªèƒ½è¿›è¡ŒçŠ¶æ€å›é€€ï¼Œåº”è¯¥å»è¯·æ•™å½±å­çŠ¶æ€ `X` åº”è¯¥å›é€€åˆ°å“ªé‡Œï¼ˆ`dp[j][other] = dp[X][other]`ï¼Œå…¶ä¸­ `other` æ˜¯é™¤äº† `pat[j]` ä¹‹å¤–æ‰€æœ‰å­—ç¬¦ï¼‰ã€‚

å¯¹äºå½±å­çŠ¶æ€ `X`ï¼Œæˆ‘ä»¬æŠŠå®ƒåˆå§‹åŒ–ä¸º 0ï¼Œå¹¶ä¸”éšç€ `j` çš„å‰è¿›è¿›è¡Œæ›´æ–°ï¼Œæ›´æ–°çš„æ–¹å¼å’Œ search è¿‡ç¨‹æ›´æ–° `j` çš„è¿‡ç¨‹éå¸¸ç›¸ä¼¼ï¼ˆ`X = dp[X][pat[j]]`ï¼‰ã€‚

KMP ç®—æ³•ä¹Ÿå°±æ˜¯åŠ¨æ€è§„åˆ’é‚£ç‚¹äº‹ï¼Œæˆ‘ä»¬çš„å…¬ä¼—å·æ–‡ç« ç›®å½•æœ‰ä¸€ç³»åˆ—ä¸“é—¨è®²åŠ¨æ€è§„åˆ’çš„ï¼Œè€Œä¸”éƒ½æ˜¯æŒ‰ç…§ä¸€å¥—æ¡†æ¶æ¥çš„ï¼Œæ— éå°±æ˜¯æè¿°é—®é¢˜é€»è¾‘ï¼Œæ˜ç¡® `dp` æ•°ç»„å«ä¹‰ï¼Œå®šä¹‰ base case è¿™ç‚¹ç ´äº‹ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©å¤§å®¶å¯¹åŠ¨æ€è§„åˆ’æœ‰æ›´æ·±çš„ç†è§£ã€‚



<hr>
<details class="hint-container details">
<summary><strong>å¼•ç”¨æœ¬æ–‡çš„æ–‡ç« </strong></summary>

 - [æˆ‘çš„åˆ·é¢˜å¿ƒå¾—](https://labuladong.github.io/article/fname.html?fname=ç®—æ³•å¿ƒå¾—)
 - [æ»‘åŠ¨çª—å£ç®—æ³•å»¶ä¼¸ï¼šRabin Karp å­—ç¬¦åŒ¹é…ç®—æ³•](https://labuladong.github.io/article/fname.html?fname=rabinkarp)

</details><hr>





**ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿**

**ã€Šlabuladong çš„ç®—æ³•å°æŠ„ã€‹å·²ç»å‡ºç‰ˆï¼Œå…³æ³¨å…¬ä¼—å·æŸ¥çœ‹è¯¦æƒ…ï¼›åå°å›å¤ã€Œ**å…¨å®¶æ¡¶**ã€å¯ä¸‹è½½é…å¥— PDF å’Œåˆ·é¢˜å…¨å®¶æ¡¶**ï¼š

![](https://labuladong.github.io/pictures/souyisou2.png)

======å…¶ä»–è¯­è¨€ä»£ç ======

[28.å®ç° strStr()](https://leetcode-cn.com/problems/implement-strstr)

### python

[MoguCloud](https://github.com/MoguCloud) æä¾› å®ç° strStr() çš„ Python å®Œæ•´ä»£ç ï¼š

```python
class Solution:
  def strStr(self, haystack: str, needle: str) -> int:
    # è¾¹ç•Œæ¡ä»¶åˆ¤æ–­
    if not needle:
      return 0
    pat = needle
    txt = haystack

    M = len(pat)
    # dp[çŠ¶æ€][å­—ç¬¦] = ä¸‹ä¸ªçŠ¶æ€
    dp = [[0 for _ in range(256)] for _ in pat]
    # base case
    dp[0][ord(pat[0])] = 1
    # å½±å­çŠ¶æ€ X åˆå§‹åŒ–ä¸º 0
    X = 0
    for j in range(1, M):
      for c in range(256):
        dp[j][c] = dp[X][c]
        dp[j][ord(pat[j])] = j + 1
        # æ›´æ–°å½±å­çŠ¶æ€
        X = dp[X][ord(pat[j])]

        N = len(txt)
        # pat åˆå§‹çŠ¶æ€ä¸º 0 
        j = 0
        for i in range(N):
          # è®¡ç®— pat çš„ä¸‹ä¸€ä¸ªçŠ¶æ€
          j = dp[j][ord(txt[i])]
          # åˆ°è¾¾ç»ˆæ­¢æ€ï¼Œè¿”å›ç»“æœ
          if j == M:
            return i - M + 1
          # æ²¡åˆ°è¾¾ç»ˆæ­¢æ€ï¼ŒåŒ¹é…å¤±è´¥
          return -1
```



### javascript

```js
class KMP {
  constructor(pat) {
    this.pat = pat;
    let m = pat.length;

    // dp[çŠ¶æ€][å­—ç¬¦] = ä¸‹ä¸ªçŠ¶æ€  åˆå§‹åŒ–ä¸€ä¸ªm*256çš„æ•´æ•°çŸ©é˜µ
    this.dp = new Array(m);
    for (let i = 0; i < m; i++) {
      this.dp[i] = new Array(256);
      this.dp[i].fill(0, 0, 256);
    }

    // base case
    this.dp[0][this.pat[0].charCodeAt()] = 1;

    // å½±å­çŠ¶æ€X åˆå§‹ä¸º0
    let x = 0;

    // æ„å»ºçŠ¶æ€è½¬ç§»å›¾
    for (let j = 1; j < m; j++) {
      for (let c = 0; c < 256; c++) {
        this.dp[j][c] = this.dp[x][c];
      }

      // dp[][å¯¹åº”çš„ASCIIç ]
      this.dp[j][this.pat[j].charCodeAt()] = j + 1;

      // æ›´æ–°å½±å­çŠ¶æ€
      x = this.dp[x][this.pat[j].charCodeAt()]
    }
  }

  search(txt) {

    let m = this.pat.length;
    let n = txt.length;

    // patçš„åˆå§‹æ€ä¸º0
    let j = 0;
    for (let i = 0; i < n; i++) {
      // è®¡ç®—patçš„ä¸‹ä¸€ä¸ªçŠ¶æ€
      j = this.dp[j][txt[i].charCodeAt()];

      // åˆ°è¾¾ç»ˆæ­¢æ€ è¿”å›ç»“æœ
      if (j === m) return i - m + 1;
    }

    // æ²¡åˆ°ç»ˆæ­¢æ€ åŒ¹é…å¤±è´¥
    return -1;
  }

}

/**
 * @param {string} haystack
 * @param {string} needle
 * @return {number}
 */
var strStr = function(haystack, needle) { 
  if(haystack === ""){
    if(needle !== ""){
      return -1;
    }
    return 0;
  }

  if(needle === ""){
    return 0;
  }
  let kmp = new KMP(needle);
  return kmp.search(haystack)
};
```



